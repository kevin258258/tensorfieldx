<div class="fixed inset-0 z-0 w-full h-full bg-cover bg-center pointer-events-none grayscale brightness-[0.4] contrast-125"
     style="background-image: url('https://images.unsplash.com/photo-1518640467707-6811f4a6ab73?q=80&w=2660&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
</div>

<canvas id="flashlight-canvas" class="fixed inset-0 z-1 w-full h-full pointer-events-none"></canvas>

<div class="fixed inset-0 z-2 w-full h-full pointer-events-none opacity-[0.08] mix-blend-overlay"
     style="background-image: linear-gradient(to right, #ffffff 1px, transparent 1px), linear-gradient(to bottom, #ffffff 1px, transparent 1px); background-size: 60px 60px;">
</div>

<div class="fixed inset-0 z-3 w-full h-full pointer-events-none opacity-[0.05]"
     style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%270 0 200 200%27 xmlns=%27http://www.w3.org/2000/svg%27%3E%3Cfilter id=%27noiseFilter%27%3E%3CfeTurbulence type=%27fractalNoise%27 baseFrequency=%270.65%27 numOctaves=%273%27 stitchTiles=%27stitch%27/%3E%3C/filter%3E%3Crect width=%27100%25%27 height=%27100%25%27 filter=%27url(%23noiseFilter)%27/%3E%3C/svg%3E');">
</div>

<script>
  // å°†æ‰€æœ‰é€»è¾‘å°è£…åœ¨å‡½æ•°é‡Œ
  function initFlashlight() {
      const canvas = document.getElementById('flashlight-canvas') as HTMLCanvasElement;
      if (!canvas) return; // æ‰¾ä¸åˆ°ç”»å¸ƒå°±é€€å‡º

      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      const VOID_COLOR = '#050508'; 
      let width: number, height: number;
      let mouseX = -999, mouseY = -999;
      let animationFrameId: number;

      const resize = () => {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        // å¼ºåˆ¶é‡ç»˜ä¸€æ¬¡é»‘è‰²ï¼Œé˜²æ­¢ resize æ—¶é—ªçƒ
        ctx.fillStyle = VOID_COLOR;
        ctx.fillRect(0, 0, width, height);
      };

      // å¿…é¡»ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼ˆè™½ç„¶ Astro æ¢é¡µä¼šé”€æ¯ DOMï¼Œä½† window ä¸Šçš„äº‹ä»¶è¿˜åœ¨ï¼‰
      const handleMouseMove = (e: MouseEvent) => {
          mouseX = e.clientX;
          mouseY = e.clientY;
      };
      const handleTouch = (e: TouchEvent) => {
    // é˜»æ­¢è§¦æ‘¸æ—¶çš„é»˜è®¤æ»šåŠ¨è¡Œä¸ºï¼ˆå¯é€‰ï¼Œå¦‚æœä½ å¸Œæœ›åˆ’åŠ¨æ—¶æ‰‹ç”µç­’ç´§è·Ÿæ‰‹æŒ‡ï¼‰
    // e.preventDefault(); 
    mouseX = e.touches[0].clientX;
    mouseY = e.touches[0].clientY;
};

// ç»‘å®šè§¦æ‘¸äº‹ä»¶
window.addEventListener('touchstart', handleTouch);
window.addEventListener('touchmove', handleTouch);

// åˆ«å¿˜äº†åœ¨ astro:page-load çš„æ¸…ç†é€»è¾‘ä¸­ä¹Ÿç§»é™¤å®ƒä»¬
window.removeEventListener('touchstart', (window as any)._bgTouchHandler);
window.removeEventListener('touchmove', (window as any)._bgTouchHandler);
(window as any)._bgTouchHandler = handleTouch;
      
      // æ¸…ç†æ—§äº‹ä»¶ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
      window.removeEventListener('mousemove', (window as any)._bgMouseMoveHandler);
      window.removeEventListener('resize', (window as any)._bgResizeHandler);

      // ç»‘å®šæ–°äº‹ä»¶
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('resize', resize);
      
      // æŒ‚è½½åˆ° window ä»¥ä¾¿ä¸‹æ¬¡ç§»é™¤
      (window as any)._bgMouseMoveHandler = handleMouseMove;
      (window as any)._bgResizeHandler = resize;

      const draw = () => {
        // 1. é‡ç½®ä¸ºçº¯é»‘é®æŒ¡
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = VOID_COLOR;
        ctx.fillRect(0, 0, width, height);

        // 2. æŒ–æ´ (æ‰‹ç”µç­’)
        ctx.globalCompositeOperation = 'destination-out';
        const flashlightRadius = 400;
        const gradient = ctx.createRadialGradient(mouseX, mouseY, 0, mouseX, mouseY, flashlightRadius);
        gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');
        gradient.addColorStop(0.8, 'rgba(0, 0, 0, 0.2)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(mouseX, mouseY, flashlightRadius, 0, Math.PI * 2);
        ctx.fill();

        // 3. è£…é¥°
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#2E5CFF';
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        const crossSize = 15;
        ctx.moveTo(mouseX - crossSize, mouseY);
        ctx.lineTo(mouseX + crossSize, mouseY);
        ctx.moveTo(mouseX, mouseY - crossSize);
        ctx.lineTo(mouseX, mouseY + crossSize);
        ctx.stroke();

        ctx.strokeStyle = 'rgba(46, 92, 255, 0.3)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(mouseX, mouseY, flashlightRadius * 0.8, 0, Math.PI * 2);
        ctx.stroke();

        animationFrameId = requestAnimationFrame(draw);
      };

      // åˆå§‹åŒ–
      resize();
      
      // å–æ¶ˆæ—§çš„åŠ¨ç”»å¸§ï¼ˆé˜²æ­¢å¤šä¸ªå¾ªç¯åŒæ—¶è·‘ï¼‰
      if ((window as any)._bgAnimId) cancelAnimationFrame((window as any)._bgAnimId);
      draw();
      // ä¿å­˜ ID
      (window as any)._bgAnimId = animationFrameId;
  }

  // ğŸš€ å…³é”®ä¿®å¤ï¼šåœ¨æ¯æ¬¡é¡µé¢åŠ è½½/åˆ‡æ¢æ—¶è¿è¡Œ
  document.addEventListener('astro:page-load', initFlashlight);

</script>