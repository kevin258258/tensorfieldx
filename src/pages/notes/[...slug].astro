---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidenote from '../../components/Sidenote.astro';
import { Calendar, Clock, ArrowLeft } from 'lucide-react';

export async function getStaticPaths() {
    const posts = await getCollection('notes');
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: post,
    }));
}

const post = Astro.props;
const { Content, headings } = await post.render();
---

<BaseLayout title={post.data.title}>
    
    <div class="fixed top-0 left-0 w-full h-1 z-50 pointer-events-none">
        <div class="h-full bg-accent/50 w-[0%]" id="progress-bar"></div> 
    </div>

    <article class="max-w-[98vw] lg:max-w-[1600px] mx-auto mt-12 lg:mt-20 grid grid-cols-1 lg:grid-cols-12 gap-8 px-4 lg:px-0 min-h-screen">
        
        <aside class="hidden lg:block lg:col-span-2 lg:col-start-1 h-full relative pl-6">
            <div class="sticky top-32 border-l border-white/10 pl-6 py-2 transition-opacity duration-300 hover:opacity-100 opacity-40">
                
                <a href="/notes" class="flex items-center gap-2 text-[10px] font-mono text-gray-500 mb-8 hover:text-accent transition-colors">
                    <ArrowLeft class="w-3 h-3" /> BACK_TO_INDEX
                </a>

                <h3 class="font-mono text-[10px] text-accent uppercase tracking-widest mb-6 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>
                    // Structure
                </h3>
                <ul class="space-y-3 font-mono text-xs">
                    {headings.map((heading) => (
                        <li class={`
                            ${heading.depth === 2 ? 'font-bold text-gray-300' : 'pl-3 text-gray-500'} 
                            hover:text-accent transition-colors duration-200
                        `}>
                            <a href={`#${heading.slug}`} class="block truncate leading-relaxed">
                                {heading.depth === 3 && <span class="mr-1 opacity-50">-</span>}
                                {heading.text}
                            </a>
                        </li>
                    ))}
                </ul>
            </div>
        </aside>

        <div class="lg:col-span-8 lg:col-start-3 relative mb-32">
            
            <header class="mb-12 pl-1"> <div class="flex flex-wrap items-center gap-4 font-mono text-[10px] text-accent mb-6 border-b border-white/10 pb-4">
                    <span class="bg-accent/10 px-2 py-1 rounded text-accent border border-accent/20">
                        {post.slug.split('/')[0].toUpperCase()}
                    </span>
                    <span class="flex items-center gap-1 text-gray-500">
                        <Calendar class="w-3 h-3" />
                        {post.data.pubDate.toLocaleDateString('en-CA')}
                    </span>
                    <span class="flex items-center gap-1 text-gray-500">
                        <Clock class="w-3 h-3" />
                        {(post.body.length / 500).toFixed(0)} MIN READ
                    </span>
                </div>

                <h1 class="text-4xl md:text-6xl lg:text-7xl font-serif font-bold mb-8 leading-[1.1] text-white tracking-tight">
                    {post.data.title}
                </h1>

                {post.data.tags && (
                    <div class="flex flex-wrap gap-2">
                        {post.data.tags.map(tag => (
                            <span class="text-[10px] font-mono text-gray-400 border border-white/10 px-2 py-1 hover:text-accent hover:border-accent/50 transition-colors cursor-default">
                                #{tag}
                            </span>
                        ))}
                    </div>
                )}
            </header>

            <div class="prose prose-invert prose-lg max-w-none 
                bg-[#050505]/80 backdrop-blur-xl
                border border-white/10 rounded-lg
                p-8 md:p-16  
                shadow-2xl shadow-black/50
                
                prose-headings:font-serif prose-headings:font-bold prose-headings:text-white prose-headings:scroll-mt-24
                prose-p:text-gray-300 prose-p:leading-8 prose-p:font-sans prose-p:opacity-90
                prose-strong:text-white prose-strong:font-bold
                prose-a:text-accent prose-a:no-underline prose-a:border-b prose-a:border-accent/30 hover:prose-a:border-accent hover:prose-a:bg-accent/10 prose-a:transition-all
                prose-li:text-gray-400 prose-li:marker:text-accent
                
                overflow-visible relative z-10">
                
                <Content components={{ Sidenote }} />
                
            </div>

            <div class="mt-16 flex items-center justify-center gap-4 opacity-30">
                <div class="h-px w-12 bg-white"></div>
                <span class="font-mono text-[10px] tracking-widest text-white">END_OF_FILE</span>
                <div class="h-px w-12 bg-white"></div>
            </div>

        </div>

        <div class="hidden lg:block lg:col-span-2"></div>

    </article>
</BaseLayout>

<script>
    // 简单的阅读进度条逻辑
    window.addEventListener('scroll', () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        const bar = document.getElementById("progress-bar");
        if(bar) bar.style.width = scrolled + "%";
    });
</script>