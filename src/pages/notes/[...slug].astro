---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidenote from '../../components/Sidenote.astro';

export async function getStaticPaths() {
	const posts = await getCollection('notes');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}

const post = Astro.props;
// 1. 关键：从 render() 结果中提取 headings (标题结构)
const { Content, headings } = await post.render();
---

<BaseLayout title={post.data.title}>
    
    <article class="max-w-[98vw] lg:max-w-[1600px] mx-auto mt-8 lg:mt-16 grid grid-cols-1 lg:grid-cols-12 gap-8 px-4">
        
        <header class="lg:col-span-7 lg:col-start-3 mb-12 border-b border-white/10 pb-8">
            <div class="font-mono text-xs text-acid-green mb-4">
                // {post.data.tags?.join(' // ')}
            </div>
            <h1 class="text-4xl md:text-6xl font-serif font-bold mb-6 leading-tight text-white">
                {post.data.title}
            </h1>
            <div class="grid grid-cols-3 gap-4 font-mono text-[10px] text-gray-500 uppercase tracking-widest mt-8">
                 <div><span class="block text-gray-700">Pub_Date</span><span class="text-gray-300">{post.data.pubDate.toLocaleDateString()}</span></div>
                 <div><span class="block text-gray-700">ID</span><span class="text-gray-300">{post.slug.slice(0,6).toUpperCase()}</span></div>
                 <div><span class="block text-gray-700">Est_Time</span><span class="text-gray-300">{(post.body.length / 500).toFixed(0)} MIN</span></div>
            </div>
        </header>

        <aside class="hidden lg:block lg:col-span-2 lg:col-start-1 h-full relative">
            <div class="sticky top-24 border-r border-white/10 pr-6">
                <h3 class="font-mono text-[10px] text-gray-500 uppercase tracking-widest mb-4">
                    // Structure
                </h3>
                <ul class="space-y-3 font-mono text-xs">
                    {headings.map((heading) => (
                        <li class={`pl-${(heading.depth - 1) * 3} border-l-2 ${heading.depth === 2 ? 'border-white/20' : 'border-transparent'}`}>
                            <a href={`#${heading.slug}`} class="block text-gray-500 hover:text-acid-green hover:translate-x-1 transition-all duration-200 truncate">
                                {heading.text}
                            </a>
                        </li>
                    ))}
                </ul>
            </div>
        </aside>

        <div class="lg:col-span-7 lg:col-start-3 relative">
            <div class="prose prose-invert prose-lg max-w-none
                        prose-headings:font-serif prose-headings:font-bold prose-headings:text-white
                        prose-p:text-gray-300 prose-p:leading-relaxed prose-p:font-serif
                        prose-a:text-acid-green prose-a:no-underline hover:prose-a:underline
                        prose-code:text-acid-green prose-code:bg-white/5 prose-code:px-1 prose-code:font-mono prose-code:text-sm
                        prose-blockquote:border-l-acid-green prose-blockquote:bg-white/5 prose-blockquote:py-2 prose-blockquote:px-4 prose-blockquote:not-italic prose-blockquote:font-mono prose-blockquote:text-sm prose-blockquote:text-gray-400
                        overflow-visible">
                <Content components={{ Sidenote }} />
            </div>
            <div class="mt-20 pt-10 border-t border-white/10 font-mono text-xs text-gray-500 text-center">
                *** END OF TRANSMISSION ***
            </div>
        </div>

        <div class="hidden lg:block lg:col-span-3 border-l border-white/5 h-full opacity-50"></div>

    </article>
</BaseLayout>