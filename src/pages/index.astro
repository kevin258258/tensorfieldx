---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 1. 获取数据
const allNotes = await getCollection('notes');
const sortedNotes = allNotes.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 提取最新头条
const latestNote = sortedNotes[0];
const recentNotes = sortedNotes.slice(1, 6); // 中间栏显示的流

// 2.【新增】分类逻辑：构建学科索引
// 这是一个简单的分类器，根据 Tags 把文章分发到不同数组
const sections = {
	"PHYSICS": sortedNotes.filter(note => note.data.tags?.includes('PHYSICS')),
	"MATH":    sortedNotes.filter(note => note.data.tags?.includes('MATH')),
	// 对于 CS，我们把 DL, HPC, SYSTEM 等子领域都算进去
	"COMPUTER_SCI": sortedNotes.filter(note => 
		note.data.tags?.some(t => ['CS', 'DL', 'HPC', 'SYSTEM', 'AI'].includes(t))
	)
};

const formula = "S = -k \\sum p_i \\ln p_i";
---

<BaseLayout title="Home">
	
	<section class="flex flex-col justify-center items-center min-h-[90vh] relative">
		<div class="border-l-2 border-white pl-8 relative">
			<div class="absolute -left-[9px] -top-8 bg-acid-green text-black px-2 py-1 text-xs font-bold tracking-widest">
				SYS_ONLINE
			</div>
			<h1 class="font-serif text-6xl md:text-9xl mb-6 leading-none tracking-tighter">
				Tensor<br/>
				<span class="text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-600">Field</span><span class="text-acid-green">X</span>
			</h1>
			<p class="text-gray-400 text-sm md:text-base max-w-lg mb-12 tracking-wide">
				// A DIGITAL GARDEN FOR PHYSICS & COMPUTER SCIENCE <br>
				// LOCATED AT /home/manifold
			</p>
			<div class="mt-8 bg-white/5 border border-white/20 p-6 backdrop-blur-sm">
				<p class="text-xs text-acid-green mb-4">LATEST_COMPUTATION:</p>
				<div class="text-2xl md:text-4xl font-serif">
					$$ {formula} $$
				</div>
			</div>
		</div>
		<div class="absolute bottom-8 animate-bounce">
			<span class="text-gray-500 text-xs font-mono">SCROLL_FOR_DATA</span>
			<svg class="w-6 h-6 text-acid-green mx-auto mt-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
			</svg>
		</div>
	</section>

	<section class="min-h-screen py-20 border-t border-white/10">
		<div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
			
			<aside class="lg:col-span-3 space-y-8">
				
				{Object.entries(sections).map(([category, notes]) => (
					<div class="bg-white/5 border border-white/10 p-6">
						<h3 class="font-mono text-acid-green text-sm mb-4 border-b border-white/10 pb-2">
							// {category}
						</h3>
						
						{notes.length > 0 ? (
							<ul class="space-y-3 font-mono text-sm text-gray-400">
								{notes.map((note) => (
									<li>
										<a href={`/tensorfieldx/notes/${note.slug}`} class="hover:text-white group flex gap-2 items-start">
											<span class="text-gray-600 text-xs mt-1">::</span>
											<span class="group-hover:translate-x-1 transition-transform truncate">
												{note.data.title}
											</span>
										</a>
									</li>
								))}
							</ul>
						) : (
							<div class="text-xs text-gray-600 italic py-2">
								[NO_DATA_YET]
							</div>
						)}
					</div>
				))}

			</aside>


			<main class="lg:col-span-6 space-y-8">
				
				{latestNote && (
					<article class="group relative bg-void-blue border border-white/20 overflow-hidden hover:border-acid-green/50 transition-colors">
						<div class="absolute top-0 right-0 bg-acid-green text-black text-xs font-bold px-3 py-1">
							LATEST_RESEARCH
						</div>
						<div class="p-8 min-h-[300px] flex flex-col justify-end bg-gradient-to-t from-black/80 to-transparent">
							<div class="flex gap-2 mb-4">
								{latestNote.data.tags?.map(tag => (
									<span class="text-xs font-mono text-acid-green bg-acid-green/10 px-2 py-0.5 rounded">
										{tag}
									</span>
								))}
							</div>
							<h2 class="text-4xl font-serif font-bold mb-4 group-hover:text-acid-green transition-colors">
								<a href={`/tensorfieldx/notes/${latestNote.slug}`}>
									{latestNote.data.title}
								</a>
							</h2>
							<p class="text-gray-400 line-clamp-2">
								{latestNote.data.description}
							</p>
						</div>
					</article>
				)}

				<div class="space-y-4">
					<h3 class="font-mono text-gray-500 text-sm pl-2 border-l-2 border-acid-green">
						STREAM_DATA
					</h3>
					{recentNotes.map(note => (
						<div class="p-6 bg-white/5 border border-white/10 hover:bg-white/10 transition-colors">
							<div class="flex justify-between items-baseline mb-2">
								<h4 class="text-xl font-serif font-bold">
									<a href={`/tensorfieldx/notes/${note.slug}`}>{note.data.title}</a>
								</h4>
								<span class="font-mono text-xs text-gray-500">
									{note.data.pubDate.toLocaleDateString()}
								</span>
							</div>
							<p class="text-sm text-gray-400 line-clamp-2">
								{note.data.description}
							</p>
						</div>
					))}
				</div>
			</main>


			<aside class="lg:col-span-3 space-y-8">
				<div class="bg-white/5 border border-white/10 p-6 text-center">
					<div class="w-20 h-20 mx-auto bg-gray-700 rounded-full mb-4 overflow-hidden border-2 border-acid-green">
						<div class="w-full h-full flex items-center justify-center text-2xl font-serif">M</div>
					</div>
					<h3 class="font-serif text-xl font-bold mb-1">Manifold</h3>
					<p class="text-xs font-mono text-gray-500 mb-4">CS @ SUSTech</p>
					
					<div class="flex justify-center gap-4 text-xs font-mono border-t border-white/10 pt-4">
						<div class="text-center">
							<span class="block text-acid-green font-bold text-lg">{allNotes.length}</span>
							<span class="text-gray-500">POSTS</span>
						</div>
						<div class="text-center">
							<span class="block text-acid-green font-bold text-lg">3</span>
							<span class="text-gray-500">PROJS</span>
						</div>
					</div>
				</div>

				<div class="p-4 border border-white/10 font-mono text-xs space-y-2">
					<div class="flex justify-between">
						<span class="text-gray-500">STATUS</span>
						<span class="text-acid-green animate-pulse">● ONLINE</span>
					</div>
					<div class="flex justify-between">
						<span class="text-gray-500">LATENCY</span>
						<span class="text-gray-300">12ms</span>
					</div>
					<div class="flex justify-between">
						<span class="text-gray-500">LOC</span>
						<span class="text-gray-300">Shenzhen, CN</span>
					</div>
				</div>
			</aside>

		</div>
	</section>
</BaseLayout>